# This HTML file is used to display a map with nearby stores that have available stock.
# It uses the Google Maps API to show the user's location and the locations of nearby stores.
# The map is centered on the user's location, and markers are placed on the map for each store.
# The stores are fetched from the Django API based on the user's latitude and longitude.
# The map also includes an info window that displays details about each store when clicked.
# The HTML file is structured with a head section for metadata and styles, and a body section for the content.
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carte des boutiques proches</title>
    <style>
        /* Style de la carte */
        #map {
            height: 600px;
            width: 100%;
            border: 1px solid #ccc;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <h2 style="text-align:center;">Boutiques les plus proches avec stock disponible</h2>

    <div id="map"></div>

    <script>
        // Fonction principale appelée une fois que la carte est chargée
        function initMap() {
            // Vérifie si la géolocalisation est supportée par le navigateur
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const userLatLng = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Initialise la carte centrée sur la position de l'utilisateur
                    const map = new google.maps.Map(document.getElementById('map'), {
                        center: userLatLng,
                        zoom: 12
                    });

                    // Marqueur pour l'utilisateur
                    new google.maps.Marker({
                        position: userLatLng,
                        map: map,
                        title: "Votre position",
                        icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    });

                    // Appel à l'API Django pour récupérer les boutiques proches
                    fetch(`/api/boutiques-produits/?lat=${userLatLng.lat}&lon=${userLatLng.lng}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.length === 0) {
                                alert("Aucune boutique proche avec du stock disponible.");
                                return;
                            }

                            data.forEach((boutique, index) => {
                                const boutiqueLatLng = {
                                    lat: boutique.lat,
                                    lng: boutique.lon
                                };

                                const infoContent = `
                                    <div>
                                        <strong>${index + 1}. ${boutique.boutique}</strong><br>
                                        Ville : ${boutique.ville}<br>
                                        Produit : ${boutique.produit}<br>
                                        Marque : ${boutique.marque}<br>
                                        Modèle : ${boutique.modele}<br>
                                        Prix : ${boutique.prix} €<br>
                                        Quantité : ${boutique.quantite}<br>
                                        Distance : ${boutique.distance_km} km
                                    </div>
                                `;

                                const marker = new google.maps.Marker({
                                    position: boutiqueLatLng,
                                    map: map,
                                    label: `${index + 1}`,  // Numérote les boutiques
                                    title: boutique.boutique
                                });

                                const infoWindow = new google.maps.InfoWindow({
                                    content: infoContent
                                });

                                marker.addListener('click', () => {
                                    infoWindow.open(map, marker);
                                });
                            });
                        })
                        .catch(error => {
                            console.error("Erreur lors de la récupération des données : ", error);
                        });

                }, function() {
                    alert("Impossible de récupérer votre position.");
                });
            } else {
                alert("La géolocalisation n'est pas supportée par ce navigateur.");
            }
        }
    </script>

    <!-- Intégration de la Clé API Google Maps -->
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6iCA5P0ycIXnG_UMuxZWOYoA5fxK_XjA&callback=initMap">
    </script>
</body>
</html>
